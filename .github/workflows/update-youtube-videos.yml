name: update-youtube-videos

on:
  # Run every Monday at 9 AM UTC
  schedule:
    - cron: '0 9 * * 1'

  # Allow manual trigger
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-videos:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          cd scripts
          pip install google-api-python-client google-auth google-auth-httplib2

      - name: Check if classified_videos.json exists
        id: check_file
        run: |
          if [ -f "scripts/classified_videos.json" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "ðŸ“š Found existing classified videos"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "ðŸ†• No existing data, will fetch all videos"
          fi

      - name: Scrape YouTube videos
        id: scrape
        env:
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_DATA_API_KEY }}
        run: |
          cd scripts

          # Get channel handle from config
          CHANNEL_HANDLE=$(jq -r '.channel.handle // .channel.channel_id' config.json)

          echo "ðŸ” Fetching videos from YouTube channel: $CHANNEL_HANDLE"
          python youtube_scraper_api.py \
            --api-key "$YOUTUBE_API_KEY" \
            --channel-handle "$CHANNEL_HANDLE" \
            --output new_videos.json

          echo "âœ“ Scraped $(jq '. | length' new_videos.json) videos"

      - name: Merge with existing data
        if: steps.check_file.outputs.exists == 'true'
        run: |
          cd scripts
          echo "ðŸ”„ Merging with existing classified videos..."
          python merge_videos.py \
            --existing classified_videos.json \
            --new new_videos.json \
            --output merged_videos.json

          # Count new videos
          NEW_COUNT=$(jq '[.[] | select(.type == "")] | length' merged_videos.json)
          echo "new_count=$NEW_COUNT" >> $GITHUB_ENV
          echo "ðŸ“Š Found $NEW_COUNT new unclassified videos"

          # Use merged data
          mv merged_videos.json classified_videos.json

      - name: Auto-classify videos
        run: |
          cd scripts
          INPUT_FILE="classified_videos.json"
          if [ ! -f "$INPUT_FILE" ]; then
            INPUT_FILE="new_videos.json"
          fi

          echo "ðŸ¤– Auto-classifying videos using config rules..."
          python auto_classify.py \
            --input "$INPUT_FILE" \
            --output classified_videos.json \
            --config config.json

      - name: Generate content files
        run: |
          cd scripts
          echo "ðŸ“ Generating markdown content..."
          python generate_content.py \
            --input classified_videos.json \
            --content-dir ../src/content \
            --overwrite

      - name: Check for changes
        id: changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ“ Changes detected"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No changes detected"
          fi

      - name: Commit and push changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A
          git commit -m "Update YouTube videos and podcasts

          - Scraped latest videos from YouTube channel
          - Auto-classified videos as 'video' or 'podcast' based on title
          - Generated markdown content files

          ðŸ¤– Auto-generated by update-youtube-videos workflow"
          git push

      - name: Summary
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          echo "## ðŸŽ‰ YouTube Update Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Changes have been committed and pushed to the main branch." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### What was updated" >> $GITHUB_STEP_SUMMARY
          echo "- Scraped latest videos from YouTube channel" >> $GITHUB_STEP_SUMMARY
          echo "- Auto-classified videos as 'video' or 'podcast'" >> $GITHUB_STEP_SUMMARY
          echo "- Generated markdown content files" >> $GITHUB_STEP_SUMMARY

      - name: No changes summary
        if: steps.changes.outputs.has_changes == 'false'
        run: |
          echo "## â„¹ï¸ No Updates Needed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No new videos found. Your site is up to date!" >> $GITHUB_STEP_SUMMARY
