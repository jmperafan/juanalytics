---
import BaseLayout from '../layouts/BaseLayout.astro';
import YouTubeThumbnail from '../components/YouTubeThumbnail.astro';
import OptimizedImage from '../components/OptimizedImage.astro';
import Icon from '../components/Icon.astro';
import { getCollection } from 'astro:content';
import { readContentYAML } from '../utils/yamlParser';
import { buildUrl } from '../utils/urlHelper';

// Get content from YAML (videos and podcasts)
const content = await readContentYAML();

// Get blogs from Astro content collections
const recentBlogs = (await getCollection('blog')).sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
).slice(0, 3);

// Get recent videos from YAML
const recentVideos = content.videos
  .map(video => ({
    data: {
      title: video.title,
      description: video.description,
      pubDate: video.date,
      videoUrl: video.url,
      thumbnail: video.thumbnail,
      platform: (video.platform as 'youtube' | 'vimeo' | 'other') || 'youtube',
      tags: video.tags,
    }
  }))
  .slice(0, 3);

// Get recent guest podcast appearances from YAML (excluding SQL Lingua Franca)
const recentPodcasts = content.podcasts
  .filter(p => !p.title.includes(' - '))
  .map(podcast => ({
    slug: podcast.url.split('/').pop() || '',
    data: {
      title: podcast.title,
      description: podcast.description,
      pubDate: podcast.date,
      podcastName: podcast.podcast || podcast.extra2 || '',
      audioUrl: podcast.url,
      duration: podcast.duration,
      episode: podcast.episode || (podcast.extra1 ? parseInt(podcast.extra1) : undefined),
      thumbnail: podcast.thumbnail,
      type: (podcast.extra1 && parseInt(podcast.extra1) > 0) ? 'own' : 'guest',
      tags: podcast.tags,
    }
  }))
  .slice(0, 3);
---

<BaseLayout title="juanalytics - Juan Manuel Perafan">
  <!-- Hero Section -->
  <section class="hero-section">
    <div class="container hero-max-width">
      <div class="hero-container">
        <div>
          <OptimizedImage
            src={buildUrl("profile_photo.png")}
            alt="Juan Manuel Perafan"
            class="hero-image"
            loading="eager"
            fetchpriority="high"
            width={800}
            height={800}
          />
        </div>
        <div class="hero-content">
          <h1 class="hero-title">Juan Manuel Perafan</h1>
          <p class="hero-subtitle">
            Analytics Engineer | Community Advocate | Author | Speaker
          </p>
          <p class="hero-description">
            Welcome to my portfolio of content: talks, videos, podcasts, and blog posts. I specialize in:
          </p>
          <ul class="specialty-list">
            <li class="specialty-list-item">
              <Icon name="check" class="specialty-icon" />
              Analytics Engineering
            </li>
            <li class="specialty-list-item">
              <Icon name="check" class="specialty-icon" />
              dbt
            </li>
            <li class="specialty-list-item">
              <Icon name="check" class="specialty-icon" />
              Data Modeling
            </li>
            <li class="specialty-list-item">
              <Icon name="check" class="specialty-icon" />
              SQL
            </li>
            <li class="specialty-list-item">
              <Icon name="check" class="specialty-icon" />
              Data Visualization
            </li>
            <li class="specialty-list-item">
              <Icon name="check" class="specialty-icon" />
              Data Governance
            </li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <!-- What I Do -->
  <section class="section-with-bg">
    <div class="container hero-max-width">
      <h2 class="section-title">What You'll Find Here</h2>

      <div class="cards-grid">
        <a href={buildUrl("talks")} class="feature-card">
          <div class="feature-icon">
            <Icon name="presentation" size={24} />
          </div>
          <div class="feature-content">
            <h3>Conference Talks</h3>
            <p>Presentations from conferences and meetups</p>
          </div>
        </a>

        <a href={buildUrl("videos")} class="feature-card">
          <div class="feature-icon">
            <Icon name="play" size={24} />
          </div>
          <div class="feature-content">
            <h3>Video Tutorials</h3>
            <p>Technical deep dives and how-tos</p>
          </div>
        </a>

        <a href={buildUrl("podcasts")} class="feature-card">
          <div class="feature-icon">
            <Icon name="microphone" size={24} />
          </div>
          <div class="feature-content">
            <h3>Podcast Appearances</h3>
            <p>Conversations about data and community</p>
          </div>
        </a>

        <a href={buildUrl("blog")} class="feature-card">
          <div class="feature-icon">
            <Icon name="document" size={24} />
          </div>
          <div class="feature-content">
            <h3>Blog Posts</h3>
            <p>Articles on analytics engineering</p>
          </div>
        </a>
      </div>

      <!-- Speaking & Training -->
      <div class="cta-box">
        <h3 class="cta-title">Let's Work Together</h3>
        <p class="cta-description">
          I'm available to speak at your next conference, meetup, or corporate event, train your team on analytics engineering and the modern data stack, or provide strategic consulting for your data initiatives. Let's talk!
        </p>
        <div class="cta-grid">
          <div class="cta-item">
            <h4>
              <Icon name="microphone" size={20} />
              Speaking
            </h4>
            <ul>
              <li>• Conference keynotes</li>
              <li>• Technical deep dives</li>
              <li>• Panel discussions</li>
              <li>• Meetup presentations</li>
            </ul>
          </div>
          <div class="cta-item">
            <h4>
              <Icon name="book" size={20} />
              Training & Mentorship
            </h4>
            <ul>
              <li>• Hands-on dbt workshops</li>
              <li>• Modern data stack training</li>
              <li>• Team enablement programs</li>
              <li>• Custom curriculum design</li>
            </ul>
          </div>
          <div class="cta-item">
            <h4>
              <Icon name="package" size={20} />
              Consulting
            </h4>
            <ul>
              <li>• Data strategy & architecture</li>
              <li>• dbt implementation guidance</li>
              <li>• Analytics engineering workflows</li>
              <li>• Platform modernization</li>
            </ul>
          </div>
        </div>
        <div class="cta-button-container">
          <a href={buildUrl("about")} class="cta-button">
            Get in Touch
            <Icon name="arrow" size={16} />
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Recent Podcasts (Guest Appearances) -->
  {recentPodcasts.length > 0 && (
    <section class="recent-section">
      <div class="container">
        <div class="section-header">
          <h2>Recent Podcast Guest Appearances</h2>
          <a href={buildUrl("podcasts")} class="view-all-link">View all →</a>
        </div>
        <div class="content-grid">
          {recentPodcasts.map((podcast) => (
            <a href={podcast.data.audioUrl} target="_blank" rel="noopener noreferrer" class="card media-card">
              {podcast.data.thumbnail ? (
                <img src={podcast.data.thumbnail} alt={podcast.data.title} class="media-image" />
              ) : (
                <div class="media-placeholder">
                  <Icon name="microphone" size={64} />
                </div>
              )}
              <div class="media-content">
                <h3 class="media-title">{podcast.data.title}</h3>
                <p class="media-meta">
                  {podcast.data.pubDate.toISOString().split('T')[0]}
                  {podcast.data.podcastName && ` • ${podcast.data.podcastName}`}
                  {podcast.data.episode && ` - Episode ${podcast.data.episode}`}
                </p>
                <p class="media-description">{podcast.data.description}</p>
              </div>
            </a>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- Recent Videos -->
  {recentVideos.length > 0 && (
    <section class="recent-section section-with-bg">
      <div class="container">
        <div class="section-header">
          <h2>Recent Videos</h2>
          <a href={buildUrl("videos")} class="view-all-link">View all →</a>
        </div>
        <div class="content-grid">
          {recentVideos.map((video) => (
            <a href={video.data.videoUrl} target="_blank" rel="noopener noreferrer" class="card media-card">
              {video.data.videoUrl ? (
                <YouTubeThumbnail videoUrl={video.data.videoUrl} alt={video.data.title} thumbnail={video.data.thumbnail} />
              ) : video.data.thumbnail ? (
                <img src={video.data.thumbnail} alt={video.data.title} class="media-image" />
              ) : (
                <div class="media-placeholder">
                  <Icon name="play" size={64} />
                </div>
              )}
              <div class="media-content">
                <h3 class="media-title">{video.data.title}</h3>
                <p class="media-meta">
                  {video.data.pubDate.toISOString().split('T')[0]}
                </p>
                <p class="media-description">{video.data.description}</p>
              </div>
            </a>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- Recent Blog Posts -->
  {recentBlogs.length > 0 && (
    <section class="recent-section">
      <div class="container">
        <div class="section-header">
          <h2>Recent Blog Posts</h2>
          <a href={buildUrl("blog")} class="view-all-link">View all →</a>
        </div>
        <div class="content-grid">
          {recentBlogs.map((post) => (
            <a href={buildUrl(`blog/${post.slug}`)} class="card media-card">
              {post.data.heroImage ? (
                <OptimizedImage
                  src={buildUrl(post.data.heroImage)}
                  alt={post.data.title}
                  class="media-image"
                  loading="lazy"
                />
              ) : (
                <div class="media-placeholder">
                  <p class="placeholder-text">Add heroImage in frontmatter</p>
                </div>
              )}
              <div class="media-content">
                <h3 class="media-title">{post.data.title}</h3>
                <p class="media-meta">
                  {post.data.pubDate.toISOString().split('T')[0]}
                </p>
                <p class="media-description">{post.data.description}</p>
              </div>
            </a>
          ))}
        </div>
      </div>
    </section>
  )}
</BaseLayout>
