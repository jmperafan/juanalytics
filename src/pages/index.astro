---
import BaseLayout from '../layouts/BaseLayout.astro';
import YouTubeThumbnail from '../components/YouTubeThumbnail.astro';
import { getCollection } from 'astro:content';
import { readContentYAML } from '../utils/yamlParser';
import { buildUrl } from '../utils/urlHelper';

// Get content from YAML (videos and podcasts)
const content = await readContentYAML();

// Get blogs from Astro content collections
const recentBlogs = (await getCollection('blog')).sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
).slice(0, 3);

// Get recent videos from YAML
const recentVideos = content.videos
  .map(video => ({
    data: {
      title: video.title,
      description: video.description,
      pubDate: video.date,
      videoUrl: video.url,
      thumbnail: video.thumbnail,
      platform: (video.platform as 'youtube' | 'vimeo' | 'other') || 'youtube',
      tags: video.tags,
    }
  }))
  .slice(0, 3);

// Get recent guest podcast appearances from YAML (excluding SQL Lingua Franca)
const recentPodcasts = content.podcasts
  .filter(p => !p.title.includes(' - '))
  .map(podcast => ({
    slug: podcast.url.split('/').pop() || '',
    data: {
      title: podcast.title,
      description: podcast.description,
      pubDate: podcast.date,
      podcastName: podcast.podcast || podcast.extra2 || '',
      audioUrl: podcast.url,
      duration: podcast.duration,
      episode: podcast.episode || (podcast.extra1 ? parseInt(podcast.extra1) : undefined),
      thumbnail: podcast.thumbnail,
      type: (podcast.extra1 && parseInt(podcast.extra1) > 0) ? 'own' : 'guest',
      tags: podcast.tags,
    }
  }))
  .slice(0, 3);
---

<BaseLayout title="juanalytics - Juan Manuel Perafan">
  <!-- Hero Section -->
  <section class="hero-section">
    <div class="container hero-max-width">
      <div class="hero-container">
        <div>
          <img src={buildUrl("profile_photo.png")} alt="Juan Manuel Perafan" class="hero-image" />
        </div>
        <div class="hero-content">
          <h1 class="hero-title">Juan Manuel Perafan</h1>
          <p class="hero-subtitle">
            Analytics Engineer | Community Advocate | Author | Speaker
          </p>
          <p class="hero-description">
            Welcome to my portfolio of content: talks, videos, podcasts, and blog posts. I specialize in:
          </p>
          <ul class="specialty-list">
            <li class="specialty-list-item">
              <svg class="specialty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              Analytics Engineering
            </li>
            <li class="specialty-list-item">
              <svg class="specialty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              dbt
            </li>
            <li class="specialty-list-item">
              <svg class="specialty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              Data Modeling
            </li>
            <li class="specialty-list-item">
              <svg class="specialty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              SQL
            </li>
            <li class="specialty-list-item">
              <svg class="specialty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              Data Visualization
            </li>
            <li class="specialty-list-item">
              <svg class="specialty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              Data Governance
            </li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <!-- What I Do -->
  <section class="section-with-bg">
    <div class="container hero-max-width">
      <h2 class="section-title">What You'll Find Here</h2>

      <div class="cards-grid">
        <a href={buildUrl("talks")} class="feature-card">
          <div class="feature-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
              <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
            </svg>
          </div>
          <div class="feature-content">
            <h3>Conference Talks</h3>
            <p>Presentations from conferences and meetups</p>
          </div>
        </a>

        <a href={buildUrl("videos")} class="feature-card">
          <div class="feature-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polygon points="5 3 19 12 5 21 5 3"></polygon>
            </svg>
          </div>
          <div class="feature-content">
            <h3>Video Tutorials</h3>
            <p>Technical deep dives and how-tos</p>
          </div>
        </a>

        <a href={buildUrl("podcasts")} class="feature-card">
          <div class="feature-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
              <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
              <line x1="12" y1="19" x2="12" y2="23"></line>
              <line x1="8" y1="23" x2="16" y2="23"></line>
            </svg>
          </div>
          <div class="feature-content">
            <h3>Podcast Appearances</h3>
            <p>Conversations about data and community</p>
          </div>
        </a>

        <a href={buildUrl("blog")} class="feature-card">
          <div class="feature-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
            </svg>
          </div>
          <div class="feature-content">
            <h3>Blog Posts</h3>
            <p>Articles on analytics engineering</p>
          </div>
        </a>
      </div>

      <!-- Speaking & Training -->
      <div class="cta-box">
        <h3 class="cta-title">Let's Work Together</h3>
        <p class="cta-description">
          I'm available to speak at your next conference, meetup, or corporate event, train your team on analytics engineering and the modern data stack, or provide strategic consulting for your data initiatives. Let's talk!
        </p>
        <div class="cta-grid">
          <div class="cta-item">
            <h4>
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                <line x1="12" y1="19" x2="12" y2="23"></line>
                <line x1="8" y1="23" x2="16" y2="23"></line>
              </svg>
              Speaking
            </h4>
            <ul>
              <li>• Conference keynotes</li>
              <li>• Technical deep dives</li>
              <li>• Panel discussions</li>
              <li>• Meetup presentations</li>
            </ul>
          </div>
          <div class="cta-item">
            <h4>
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
              </svg>
              Training & Mentorship
            </h4>
            <ul>
              <li>• Hands-on dbt workshops</li>
              <li>• Modern data stack training</li>
              <li>• Team enablement programs</li>
              <li>• Custom curriculum design</li>
            </ul>
          </div>
          <div class="cta-item">
            <h4>
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                <line x1="12" y1="22.08" x2="12" y2="12"></line>
              </svg>
              Consulting
            </h4>
            <ul>
              <li>• Data strategy & architecture</li>
              <li>• dbt implementation guidance</li>
              <li>• Analytics engineering workflows</li>
              <li>• Platform modernization</li>
            </ul>
          </div>
        </div>
        <div class="cta-button-container">
          <a href={buildUrl("about")} class="cta-button">
            Get in Touch
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="5" y1="12" x2="19" y2="12"></line>
              <polyline points="12 5 19 12 12 19"></polyline>
            </svg>
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Recent Podcasts (Guest Appearances) -->
  {recentPodcasts.length > 0 && (
    <section class="recent-section">
      <div class="container">
        <div class="section-header">
          <h2>Recent Podcast Guest Appearances</h2>
          <a href={buildUrl("podcasts")} class="view-all-link">View all →</a>
        </div>
        <div class="content-grid">
          {recentPodcasts.map((podcast) => (
            <a href={podcast.data.audioUrl} target="_blank" rel="noopener noreferrer" class="card media-card">
              {podcast.data.thumbnail ? (
                <img src={podcast.data.thumbnail} alt={podcast.data.title} class="media-image" />
              ) : (
                <div class="media-placeholder">
                  <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                    <line x1="12" y1="19" x2="12" y2="23"></line>
                    <line x1="8" y1="23" x2="16" y2="23"></line>
                  </svg>
                </div>
              )}
              <div class="media-content">
                <h3 class="media-title">{podcast.data.title}</h3>
                <p class="media-meta">
                  {podcast.data.pubDate.toISOString().split('T')[0]}
                  {podcast.data.podcastName && ` • ${podcast.data.podcastName}`}
                  {podcast.data.episode && ` - Episode ${podcast.data.episode}`}
                </p>
                <p class="media-description">{podcast.data.description}</p>
              </div>
            </a>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- Recent Videos -->
  {recentVideos.length > 0 && (
    <section class="recent-section section-with-bg">
      <div class="container">
        <div class="section-header">
          <h2>Recent Videos</h2>
          <a href={buildUrl("videos")} class="view-all-link">View all →</a>
        </div>
        <div class="content-grid">
          {recentVideos.map((video) => (
            <a href={video.data.videoUrl} target="_blank" rel="noopener noreferrer" class="card media-card">
              {video.data.videoUrl ? (
                <YouTubeThumbnail videoUrl={video.data.videoUrl} alt={video.data.title} thumbnail={video.data.thumbnail} />
              ) : video.data.thumbnail ? (
                <img src={video.data.thumbnail} alt={video.data.title} class="media-image" />
              ) : (
                <div class="media-placeholder">
                  <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="5 3 19 12 5 21 5 3"></polygon>
                  </svg>
                </div>
              )}
              <div class="media-content">
                <h3 class="media-title">{video.data.title}</h3>
                <p class="media-meta">
                  {video.data.pubDate.toISOString().split('T')[0]}
                </p>
                <p class="media-description">{video.data.description}</p>
              </div>
            </a>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- Recent Blog Posts -->
  {recentBlogs.length > 0 && (
    <section class="recent-section">
      <div class="container">
        <div class="section-header">
          <h2>Recent Blog Posts</h2>
          <a href={buildUrl("blog")} class="view-all-link">View all →</a>
        </div>
        <div class="content-grid">
          {recentBlogs.map((post) => (
            <a href={buildUrl(`blog/${post.slug}`)} class="card media-card">
              {post.data.heroImage ? (
                <img src={buildUrl(post.data.heroImage)} alt={post.data.title} class="media-image" />
              ) : (
                <div class="media-placeholder">
                  <p class="placeholder-text">Add heroImage in frontmatter</p>
                </div>
              )}
              <div class="media-content">
                <h3 class="media-title">{post.data.title}</h3>
                <p class="media-meta">
                  {post.data.pubDate.toISOString().split('T')[0]}
                </p>
                <p class="media-description">{post.data.description}</p>
              </div>
            </a>
          ))}
        </div>
      </div>
    </section>
  )}
</BaseLayout>
