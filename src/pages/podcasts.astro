---
import BaseLayout from '../layouts/BaseLayout.astro';
import ContentFilter from '../components/ContentFilter.astro';
import { readContentYAML } from '../utils/yamlParser';

const content = await readContentYAML();
const allPodcasts = content.podcasts.map(podcast => ({
  slug: podcast.url.split('/').pop() || '',
  data: {
    title: podcast.title,
    description: podcast.description,
    pubDate: podcast.date,
    podcastName: podcast.podcast || podcast.extra2 || '',
    audioUrl: podcast.url,
    duration: podcast.duration,
    episode: podcast.episode || (podcast.extra1 ? parseInt(podcast.extra1) : undefined),
    thumbnail: podcast.thumbnail,
    type: (podcast.extra1 && parseInt(podcast.extra1) > 0) ? 'own' : 'guest',
    tags: podcast.tags,
  }
}));

// SQL Lingua Franca episodes have titles with pattern "Name - Topic"
const sqlLinguaFranca = allPodcasts
  .filter(p => p.data.title.includes(' - '))
  .sort((a, b) => {
    const episodeA = typeof a.data.episode === 'number' ? a.data.episode : 0;
    const episodeB = typeof b.data.episode === 'number' ? b.data.episode : 0;
    return episodeB - episodeA;
  });
const guestAppearances = allPodcasts
  .filter(p => !p.data.title.includes(' - '))
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Get all unique tags for filtering
const allTags = allPodcasts.flatMap(p => p.data.tags || []);
---

<BaseLayout title="Podcasts | juanalytics">
  <section class="content-section">
    <div class="container">
      <div class="content-header">
        <h1>Podcasts</h1>
      </div>

      <div class="content-with-sidebar">
        <ContentFilter tags={allTags} gridId="podcasts-container" cardClass="podcast-card" />

        <div id="podcasts-container" style="flex: 1;">
          {guestAppearances.length > 0 && (
            <div class="podcast-section" id="guest-section">
              <h2 class="section-subtitle">Guest Appearances</h2>
              <div class="content-grid">
                {guestAppearances.map((podcast) => (
                  <a href={podcast.data.audioUrl} target="_blank" rel="noopener noreferrer" class="card content-card podcast-card" data-tags={JSON.stringify(podcast.data.tags || [])} data-type="guest-appearance">
                    {podcast.data.thumbnail ? (
                      <img src={podcast.data.thumbnail} alt={podcast.data.title} class="card-image" />
                    ) : (
                      <div class="card-image-placeholder">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                          <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                          <line x1="12" y1="19" x2="12" y2="23"></line>
                          <line x1="8" y1="23" x2="16" y2="23"></line>
                        </svg>
                      </div>
                    )}
                    <div class="card-content">
                      <h3 class="card-title">{podcast.data.title}</h3>
                      <p class="card-meta">
                        {podcast.data.pubDate.toISOString().split('T')[0]}
                        {podcast.data.podcastName && ` • ${podcast.data.podcastName}`}
                        {podcast.data.episode && ` - Episode ${podcast.data.episode}`}
                      </p>
                      <p class="card-description">{podcast.data.description}</p>
                      {podcast.data.tags && podcast.data.tags.length > 0 && (
                        <div class="card-tags">
                          {podcast.data.tags.map((tag) => (
                            <span class="tag content-tag" data-tag={tag}>{tag}</span>
                          ))}
                        </div>
                      )}
                    </div>
                  </a>
                ))}
              </div>
            </div>
          )}

          {sqlLinguaFranca.length > 0 && (
            <div class="podcast-section" id="sql-lingua-franca-section">
              <h2 class="section-subtitle">SQL Lingua Franca</h2>
              <div class="content-grid">
                {sqlLinguaFranca.map((podcast) => (
                  <a href={podcast.data.audioUrl} target="_blank" rel="noopener noreferrer" class="card content-card podcast-card" data-tags={JSON.stringify(podcast.data.tags || [])} data-type="sql-lingua-franca">
                    {podcast.data.thumbnail ? (
                      <img src={podcast.data.thumbnail} alt={podcast.data.title} class="card-image" />
                    ) : (
                      <div class="card-image-placeholder">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                          <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                          <line x1="12" y1="19" x2="12" y2="23"></line>
                          <line x1="8" y1="23" x2="16" y2="23"></line>
                        </svg>
                      </div>
                    )}
                    <div class="card-content">
                      <h3 class="card-title">{podcast.data.title}</h3>
                      {(podcast.data.podcastName || podcast.data.episode) && (
                        <p class="podcast-series-meta">
                          {podcast.data.podcastName && podcast.data.podcastName}
                          {podcast.data.podcastName && podcast.data.episode && ' • '}
                          {podcast.data.episode && `Episode ${podcast.data.episode}`}
                        </p>
                      )}
                      <p class="card-meta">
                        {podcast.data.pubDate.toISOString().split('T')[0]}
                        {podcast.data.duration && ` • ${podcast.data.duration}`}
                      </p>
                      <p class="card-description">{podcast.data.description}</p>
                      {podcast.data.tags && podcast.data.tags.length > 0 && (
                        <div class="card-tags">
                          {podcast.data.tags.map((tag) => (
                            <span class="tag content-tag" data-tag={tag}>{tag}</span>
                          ))}
                        </div>
                      )}
                    </div>
                  </a>
                ))}
              </div>
            </div>
          )}

          {sqlLinguaFranca.length === 0 && guestAppearances.length === 0 && (
            <p class="empty-state">No podcast episodes yet. Check back soon!</p>
          )}
        </div>
      </div>
    </div>
  </section>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const filterButtons = document.querySelectorAll('.filter-tag');
      const podcastCards = document.querySelectorAll('.podcast-card');
      const sqlLinguaFrancaSection = document.getElementById('sql-lingua-franca-section');
      const guestSection = document.getElementById('guest-section');

      function filterByTag(tag: string) {
        let sqlLinguaFrancaVisible = 0;
        let guestVisible = 0;

        podcastCards.forEach(card => {
          const cardTags = JSON.parse(card.getAttribute('data-tags') || '[]');
          const cardType = card.getAttribute('data-type');

          if (tag === 'all' || cardTags.includes(tag)) {
            (card as HTMLElement).style.display = 'flex';
            if (cardType === 'sql-lingua-franca') sqlLinguaFrancaVisible++;
            if (cardType === 'guest-appearance') guestVisible++;
          } else {
            (card as HTMLElement).style.display = 'none';
          }
        });

        // Hide section headers if no items are visible
        if (sqlLinguaFrancaSection) {
          (sqlLinguaFrancaSection as HTMLElement).style.display = sqlLinguaFrancaVisible > 0 ? 'block' : 'none';
        }
        if (guestSection) {
          (guestSection as HTMLElement).style.display = guestVisible > 0 ? 'block' : 'none';
        }
      }

      // Override ContentFilter's filterByTag function for podcast-specific logic
      filterButtons.forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          const tag = btn.getAttribute('data-tag') || 'all';
          filterByTag(tag);
        });
      });
    });
  </script>

  <style>
    .podcast-section {
      margin-bottom: 4rem;
    }

    .section-subtitle {
      font-size: 1.75rem;
      margin-bottom: 1.5rem;
      color: var(--color-text);
      font-weight: 700;
    }

    .podcast-series-meta {
      color: var(--color-primary);
      font-weight: 600;
      font-size: 0.875rem;
      margin-bottom: 0.75rem;
    }
  </style>
</BaseLayout>
