---
import BaseLayout from '../layouts/BaseLayout.astro';
import YouTubeThumbnail from '../components/YouTubeThumbnail.astro';
import ContentFilter from '../components/ContentFilter.astro';
import { readContentYAML } from '../utils/yamlParser';

const content = await readContentYAML();
const talks = content.talks.map(talk => ({
  data: {
    title: talk.title,
    description: talk.description,
    event: talk.event || talk.extra1 || '',
    eventUrl: talk.url,
    date: talk.date,
    location: talk.location || talk.extra2 || '',
    videoUrl: talk.url,
    thumbnail: talk.thumbnail,
    tags: talk.tags,
  }
}));
---

<BaseLayout title="Conference Talks | juanalytics">
  <section class="content-section">
    <div class="container">
      <div class="content-header">
        <h1>Conference Talks</h1>
      </div>
      {talks.length === 0 ? (
        <p class="empty-state">No talks yet. Check back soon!</p>
      ) : (
        <div class="content-with-sidebar">
          <ContentFilter
            tags={talks.flatMap(t => t.data.tags || [])}
            gridId="talks-grid"
            cardClass="talk-card"
          />
          <div id="talks-grid" class="content-grid">
            {talks.map((talk) => {
              const isYouTubeUrl = talk.data.videoUrl && (talk.data.videoUrl.includes('youtube') || talk.data.videoUrl.includes('youtu.be'));
              const CardElement = isYouTubeUrl ? 'div' : 'a';
              const linkProps = !isYouTubeUrl && talk.data.videoUrl ? { href: talk.data.videoUrl, target: '_blank', rel: 'noopener noreferrer' } : {};

              return (
              <CardElement
                {...linkProps}
                class="card content-card talk-card"
                data-tags={JSON.stringify(talk.data.tags || [])}
                data-video-url={talk.data.videoUrl || ''}
                data-has-video={talk.data.videoUrl ? 'true' : 'false'}
                data-is-youtube={isYouTubeUrl ? 'true' : 'false'}
              >
                <div class="video-card-wrapper">
                  {talk.data.videoUrl && talk.data.videoUrl.includes('youtube') ? (
                    <>
                      <div class="video-thumbnail-wrapper">
                        <YouTubeThumbnail videoUrl={talk.data.videoUrl} alt={talk.data.title} thumbnail={talk.data.thumbnail} />
                        <div class="play-button">
                          <svg viewBox="0 0 24 24">
                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                          </svg>
                        </div>
                      </div>
                      <div class="video-player"></div>
                    </>
                  ) : talk.data.thumbnail ? (
                    <img src={talk.data.thumbnail} alt={talk.data.title} class="card-image" />
                  ) : (
                    <div class="card-image-placeholder">
                      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2a3 3 0 0 0-3 3v4a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3z"></path>
                        <path d="M3 7v3a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V7"></path>
                        <path d="M8 19l4-7 4 7"></path>
                      </svg>
                    </div>
                  )}
                </div>
                <div class="card-content">
                  <h3 class="card-title">{talk.data.title}</h3>
                  <p class="card-meta" style="color: var(--color-primary); font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                      <line x1="16" y1="2" x2="16" y2="6"></line>
                      <line x1="8" y1="2" x2="8" y2="6"></line>
                      <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    {talk.data.event}
                  </p>
                  <p class="card-meta" style="display: flex; align-items: center; gap: 0.5rem;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <circle cx="12" cy="12" r="10"></circle>
                      <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                    {talk.data.date.toISOString().split('T')[0]}
                    {talk.data.location && (
                      <>
                        <span style="margin: 0 0.25rem;">â€¢</span>
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                          <circle cx="12" cy="10" r="3"></circle>
                        </svg>
                        {talk.data.location}
                      </>
                    )}
                  </p>
                  <p class="card-description">{talk.data.description}</p>
                  {talk.data.tags && talk.data.tags.length > 0 && (
                    <div class="card-tags">
                      {talk.data.tags.map((tag) => (
                        <span class="tag content-tag" data-tag={tag}>{tag}</span>
                      ))}
                    </div>
                  )}
                </div>
              </CardElement>
              );
            })}
          </div>
        </div>
      )}
    </div>
  </section>

  <script>
    function extractYouTubeId(url: string): string | null {
      const patterns = [
        /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\s]+)/,
        /youtube\.com\/shorts\/([^&\s]+)/
      ];

      for (const pattern of patterns) {
        const match = url.match(pattern);
        if (match) return match[1];
      }

      return null;
    }

    function extractVimeoId(url: string): string | null {
      const match = url.match(/vimeo\.com\/(\d+)/);
      return match ? match[1] : null;
    }

    function getEmbedUrl(videoUrl: string): string {
      if (videoUrl.includes('youtube.com') || videoUrl.includes('youtu.be')) {
        const videoId = extractYouTubeId(videoUrl);
        return videoId ? `https://www.youtube.com/embed/${videoId}` : '';
      } else if (videoUrl.includes('vimeo.com')) {
        const videoId = extractVimeoId(videoUrl);
        return videoId ? `https://player.vimeo.com/video/${videoId}` : '';
      }
      return videoUrl;
    }

    document.addEventListener('DOMContentLoaded', () => {
      const talkCards = document.querySelectorAll('.talk-card');

      // Video thumbnail clicks - play inline for YouTube only
      talkCards.forEach(card => {
        const isYouTube = card.getAttribute('data-is-youtube') === 'true';

        // Only add click handler for YouTube videos
        if (isYouTube) {
          const thumbnailContainer = card.querySelector('.video-card-wrapper');
          const thumbnail = card.querySelector('.video-thumbnail-wrapper');
          const playerContainer = card.querySelector('.video-player');

          if (thumbnailContainer && thumbnail && playerContainer) {
            thumbnailContainer.addEventListener('click', (e) => {
              e.stopPropagation();

              const videoUrl = card.getAttribute('data-video-url');

              if (videoUrl) {
                const embedUrl = getEmbedUrl(videoUrl);

                if (embedUrl) {
                  // Hide thumbnail and show player
                  (thumbnail as HTMLElement).style.display = 'none';
                  (playerContainer as HTMLElement).style.display = 'block';

                  // Create and insert iframe
                  const iframe = document.createElement('iframe');
                  iframe.src = embedUrl;
                  iframe.style.width = '100%';
                  iframe.style.height = '100%';
                  iframe.style.border = 'none';
                  iframe.setAttribute('allowfullscreen', '');
                  iframe.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture');

                  playerContainer.innerHTML = '';
                  playerContainer.appendChild(iframe);
                }
              }
            });
          }
        }
      });
    });
  </script>
</BaseLayout>
