---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';

export async function getStaticPaths() {
  const talks = await getCollection('talks');
  return talks.map((talk) => ({
    params: { slug: talk.slug },
    props: talk,
  }));
}

const talk = Astro.props;
const { Content } = await talk.render();

// Extract YouTube video ID for embedding
function getYouTubeEmbedUrl(url: string) {
  const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
  const match = url.match(regExp);
  const videoId = (match && match[2].length === 11) ? match[2] : null;
  return videoId ? `https://www.youtube.com/embed/${videoId}` : url;
}
---

<BaseLayout title={`${talk.data.title} - ${talk.data.event}`} description={talk.data.description}>
  <article style="padding: 4rem 0;">
    <div class="container" style="max-width: 900px;">
      <h1 style="margin-bottom: 1rem;">{talk.data.title}</h1>

      <div style="margin-bottom: 2rem;">
        <p style="color: var(--color-primary); font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem;">
          {talk.data.eventUrl ? (
            <a href={talk.data.eventUrl} target="_blank" style="color: var(--color-primary);">{talk.data.event}</a>
          ) : (
            talk.data.event
          )}
        </p>
        <p style="color: var(--color-text-light);">
          {talk.data.date.toISOString().split('T')[0]}
          {talk.data.location && ` • ${talk.data.location}`}
        </p>
      </div>

      {talk.data.tags && talk.data.tags.length > 0 && (
        <div style="margin-bottom: 2rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
          {talk.data.tags.map((tag) => (
            <span style="background: var(--color-bg-secondary); color: var(--color-text); padding: 0.375rem 0.875rem; border-radius: 1rem; font-size: 0.875rem; border: 1px solid var(--color-border);">{tag}</span>
          ))}
        </div>
      )}

      {talk.data.videoUrl && (
        <div style="margin-bottom: 2rem;">
          <div style="position: relative; padding-bottom: 56.25%; height: 0;">
            <iframe
              src={getYouTubeEmbedUrl(talk.data.videoUrl)}
              style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; border-radius: 0.5rem;"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
              allowfullscreen
            ></iframe>
          </div>
        </div>
      )}

      <div style="line-height: 1.8; font-size: 1.0625rem; margin-bottom: 2rem;">
        <Content />
      </div>

      {talk.data.slidesUrl && (
        <div style="margin-bottom: 2rem;">
          <a href={talk.data.slidesUrl} target="_blank" class="button">
            View Slides →
          </a>
        </div>
      )}

      <div style="margin-top: 4rem; padding-top: 2rem; border-top: 1px solid var(--color-border);">
        <a href="/talks" style="color: var(--color-primary);">← Back to talks</a>
      </div>
    </div>
  </article>
</BaseLayout>
