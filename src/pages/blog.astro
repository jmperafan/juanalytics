---
import BaseLayout from '../layouts/BaseLayout.astro';
import ContentFilter from '../components/ContentFilter.astro';
import OptimizedImage from '../components/OptimizedImage.astro';
import { getCollection } from 'astro:content';
import { calculateReadingTime, formatReadingTime } from '../utils/readingTime';
import { buildUrl } from '../utils/urlHelper';

const blogs = (await getCollection('blog')).sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// Calculate reading time for each blog post
const blogsWithReadingTime = await Promise.all(
  blogs.map(async (post) => {
    const { body } = post;
    const readingTime = calculateReadingTime(body);
    return { ...post, readingTime };
  })
);

// Get all unique tags for filtering
const allTags = blogsWithReadingTime.flatMap(b => b.data.tags || []);
---

<BaseLayout title="Blog | juanalytics">
  <section class="content-section">
    <div class="container">
      <div class="content-header">
        <h1>Blog</h1>
      </div>
      {blogsWithReadingTime.length === 0 ? (
        <p class="empty-state">No blog posts yet. Check back soon!</p>
      ) : (
        <div class="content-with-sidebar">
          <ContentFilter tags={allTags} gridId="blog-grid" cardClass="blog-card" />
          <div id="blog-grid" class="content-grid">
            {blogsWithReadingTime.map((post) => (
              <a href={buildUrl(`blog/${post.slug}`)} class="card content-card blog-card" data-tags={JSON.stringify(post.data.tags || [])}>
                {post.data.heroImage ? (
                  <OptimizedImage
                    src={buildUrl(post.data.heroImage)}
                    alt={post.data.title}
                    class="card-image"
                    loading="lazy"
                  />
                ) : (
                  <div class="card-image-placeholder">
                    <p>Add heroImage in frontmatter</p>
                  </div>
                )}
                <div class="card-content">
                  <h3 class="card-title">{post.data.title}</h3>
                  <p class="card-meta">
                    {post.data.pubDate.toISOString().split('T')[0]} â€¢ {formatReadingTime(post.readingTime)}
                  </p>
                  <p class="card-description">{post.data.description}</p>
                  {post.data.tags && post.data.tags.length > 0 && (
                    <div class="card-tags">
                      {post.data.tags.map((tag) => (
                        <span class="tag content-tag" data-tag={tag}>{tag}</span>
                      ))}
                    </div>
                  )}
                </div>
              </a>
            ))}
          </div>
        </div>
      )}
    </div>
  </section>
</BaseLayout>
