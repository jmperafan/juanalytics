---
import BaseLayout from '../layouts/BaseLayout.astro';
import ContentFilter from '../components/ContentFilter.astro';
import YouTubeThumbnail from '../components/YouTubeThumbnail.astro';
import Icon from '../components/Icon.astro';
import { readContentYAML } from '../utils/yamlParser';

const content = await readContentYAML();
const videos = content.videos.map(video => ({
  data: {
    title: video.title,
    description: video.description,
    pubDate: video.date,
    videoUrl: video.url,
    thumbnail: video.thumbnail,
    platform: (video.platform as 'youtube' | 'vimeo' | 'other') || 'youtube',
    tags: video.tags,
  }
}));

// Get all unique tags for filtering
const allTags = videos.flatMap(v => v.data.tags || []);
---

<BaseLayout title="Videos | juanalytics">
  <section class="content-section">
    <div class="container">
      <div class="content-header">
        <h1>Videos</h1>
      </div>
      {videos.length === 0 ? (
        <p class="empty-state">No videos yet. Check back soon!</p>
      ) : (
        <div class="content-with-sidebar">
          <ContentFilter tags={allTags} gridId="videos-grid" cardClass="video-card" />
          <div id="videos-grid" class="content-grid">
            {videos.map((video) => (
              <div
                class="card content-card video-card"
                data-tags={JSON.stringify(video.data.tags || [])}
                data-video-url={video.data.videoUrl || ''}
                data-platform={video.data.platform || 'youtube'}
              >
                <div class="video-card-wrapper">
                  {video.data.videoUrl ? (
                    <>
                      <div class="video-thumbnail-wrapper">
                        <YouTubeThumbnail videoUrl={video.data.videoUrl} alt={video.data.title} thumbnail={video.data.thumbnail} />
                        <div class="play-button">
                          <Icon name="play" width={28} height={28} />
                        </div>
                      </div>
                      <div class="video-player"></div>
                    </>
                  ) : video.data.thumbnail ? (
                    <img src={video.data.thumbnail} alt={video.data.title} class="card-image" />
                  ) : (
                    <div class="card-image-placeholder">
                      <Icon name="play" size={64} />
                    </div>
                  )}
                </div>
                <div class="card-content">
                  <h3 class="card-title">{video.data.title}</h3>
                  <p class="card-meta">
                    {video.data.pubDate.toISOString().split('T')[0]}
                  </p>
                  <p class="card-description">{video.data.description}</p>
                  {video.data.tags && video.data.tags.length > 0 && (
                    <div class="card-tags">
                      {video.data.tags.map((tag) => (
                        <span class="tag content-tag" data-tag={tag}>{tag}</span>
                      ))}
                    </div>
                  )}
                </div>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  </section>

  <script>
    import { getEmbedUrl } from '../utils/videoHelper';

    document.addEventListener('DOMContentLoaded', () => {
      const videoCards = document.querySelectorAll('.video-card');

      // Video thumbnail clicks - play inline
      videoCards.forEach(card => {
        const thumbnailWrapper = card.querySelector('.video-card-wrapper');
        const thumbnail = card.querySelector('.video-thumbnail-wrapper');
        const playerContainer = card.querySelector('.video-player');

        if (thumbnailWrapper && thumbnail && playerContainer) {
          thumbnailWrapper.addEventListener('click', (e) => {
            e.stopPropagation();

            const videoUrl = card.getAttribute('data-video-url');
            const platform = card.getAttribute('data-platform') || 'youtube';

            if (videoUrl) {
              const embedUrl = getEmbedUrl(videoUrl, platform);

              if (embedUrl) {
                // Hide thumbnail and show player
                (thumbnail as HTMLElement).style.display = 'none';
                (playerContainer as HTMLElement).style.display = 'block';

                // Create and insert iframe
                const iframe = document.createElement('iframe');
                iframe.src = embedUrl;
                iframe.style.width = '100%';
                iframe.style.height = '100%';
                iframe.style.border = 'none';
                iframe.setAttribute('allowfullscreen', '');
                iframe.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture');

                playerContainer.innerHTML = '';
                playerContainer.appendChild(iframe);
              }
            }
          });
        }
      });
    });
  </script>
</BaseLayout>
