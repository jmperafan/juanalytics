---
import { getCollection, render } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import OptimizedImage from '../../components/OptimizedImage.astro';
import { calculateReadingTime, formatReadingTime } from '../../utils/readingTime';
import { buildUrl } from '../../utils/urlHelper';

export async function getStaticPaths() {
  const blogs = await getCollection('blogs');
  return blogs.map((post) => ({
    params: { slug: post.id },
    props: post,
  }));
}

const post = Astro.props;
const { Content } = await render(post);

// Calculate reading time
const readingTime = calculateReadingTime(post.body || '');

// Prepare structured data
const blogPostStructuredData = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": post.data.title,
  "description": post.data.description,
  "image": post.data.heroImage ? `https://juanalytics.com${buildUrl(post.data.heroImage)}` : "https://juanalytics.com/profile_photo.png",
  "datePublished": post.data.pubDate.toISOString(),
  "dateModified": post.data.updatedDate ? post.data.updatedDate.toISOString() : post.data.pubDate.toISOString(),
  "author": {
    "@type": "Person",
    "name": "Juan Manuel Perafan",
    "url": "https://juanalytics.com",
    "sameAs": [
      "https://www.linkedin.com/in/jmperafan/",
      "https://github.com/jmperafan",
      "https://www.youtube.com/@juanalytics"
    ]
  },
  "publisher": {
    "@type": "Organization",
    "name": "Juanalytics",
    "logo": {
      "@type": "ImageObject",
      "url": "https://juanalytics.com/logo.png"
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": `https://juanalytics.com${buildUrl(`blog/${post.id}`)}`
  },
  "keywords": post.data.tags?.join(', ') || '',
  "articleSection": "Analytics Engineering",
  "wordCount": (post.body || '').split(/\s+/).length,
  "timeRequired": `PT${readingTime}M`
};
---

<BaseLayout title={post.data.title} description={post.data.description}>
  <!-- Blog Post Structured Data -->
  <script is:inline type="application/ld+json" set:html={JSON.stringify(blogPostStructuredData)} slot="head" />

  <article class="blog-post">
    <div class="container blog-post-container">
      {post.data.heroImage && (
        <OptimizedImage
          src={buildUrl(post.data.heroImage)}
          alt={post.data.title}
          class="blog-post-hero"
          loading="eager"
          fetchpriority="high"
        />
      )}

      <h1 class="blog-post-title">{post.data.title}</h1>

      <div class="blog-post-meta">
        <time>{post.data.pubDate.toISOString().split('T')[0]}</time>
        <span>•</span>
        <span>{formatReadingTime(readingTime)}</span>
        {post.data.updatedDate && (
          <span>• Updated {post.data.updatedDate.toISOString().split('T')[0]}</span>
        )}
      </div>

      {post.data.tags && post.data.tags.length > 0 && (
        <div class="blog-post-tags">
          {post.data.tags.map((tag) => (
            <span class="blog-post-tag">{tag}</span>
          ))}
        </div>
      )}

      <div class="blog-post-content">
        <Content />
      </div>

      <div class="blog-post-footer">
        <a href={buildUrl("blog")} class="blog-back-link">← Back to blog</a>
      </div>
    </div>
  </article>

  <script>
    // Make external links (non-YouTube) open in a new tab
    document.addEventListener('DOMContentLoaded', () => {
      const contentDiv = document.querySelector('.blog-post-content');
      if (contentDiv) {
        const links = contentDiv.querySelectorAll('a');
        links.forEach((link) => {
          const href = link.getAttribute('href');
          // Check if it's an external link (starts with http/https)
          if (href && (href.startsWith('http://') || href.startsWith('https://'))) {
            // Check if it's NOT a YouTube link (those are handled separately in video pages)
            if (!href.includes('youtube.com') && !href.includes('youtu.be')) {
              link.setAttribute('target', '_blank');
              link.setAttribute('rel', 'noopener noreferrer');
            }
          }
        });
      }
    });
  </script>
</BaseLayout>
