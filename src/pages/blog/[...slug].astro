---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { calculateReadingTime, formatReadingTime } from '../../utils/readingTime';
import { buildUrl } from '../../utils/urlHelper';

export async function getStaticPaths() {
  const blogs = await getCollection('blog');
  return blogs.map((post) => ({
    params: { slug: post.slug },
    props: post,
  }));
}

const post = Astro.props;
const { Content } = await post.render();

// Calculate reading time
const readingTime = calculateReadingTime(post.body);
---

<BaseLayout title={post.data.title} description={post.data.description}>
  <article class="blog-post">
    <div class="container blog-post-container">
      {post.data.heroImage && (
        <img src={buildUrl(post.data.heroImage)} alt={post.data.title} class="blog-post-hero" />
      )}

      <h1 class="blog-post-title">{post.data.title}</h1>

      <div class="blog-post-meta">
        <time>{post.data.pubDate.toISOString().split('T')[0]}</time>
        <span>•</span>
        <span>{formatReadingTime(readingTime)}</span>
        {post.data.updatedDate && (
          <span>• Updated {post.data.updatedDate.toISOString().split('T')[0]}</span>
        )}
      </div>

      {post.data.tags && post.data.tags.length > 0 && (
        <div class="blog-post-tags">
          {post.data.tags.map((tag) => (
            <span class="blog-post-tag">{tag}</span>
          ))}
        </div>
      )}

      <div class="blog-post-content">
        <Content />
      </div>

      <div class="blog-post-footer">
        <a href={buildUrl("blog")} class="blog-back-link">← Back to blog</a>
      </div>
    </div>
  </article>

  <script>
    // Make external links (non-YouTube) open in a new tab
    document.addEventListener('DOMContentLoaded', () => {
      const contentDiv = document.querySelector('.blog-post-content');
      if (contentDiv) {
        const links = contentDiv.querySelectorAll('a');
        links.forEach((link) => {
          const href = link.getAttribute('href');
          // Check if it's an external link (starts with http/https)
          if (href && (href.startsWith('http://') || href.startsWith('https://'))) {
            // Check if it's NOT a YouTube link (those are handled separately in video pages)
            if (!href.includes('youtube.com') && !href.includes('youtu.be')) {
              link.setAttribute('target', '_blank');
              link.setAttribute('rel', 'noopener noreferrer');
            }
          }
        });
      }
    });
  </script>
</BaseLayout>
